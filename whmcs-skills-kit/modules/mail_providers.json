{
  "type": "guide",
  "category": "mail-providers",
  "description": "WHMCS Mail Provider Modules",
  "topics": [
    {
      "title": "Provider Settings",
      "content": {
        "Validating User-Supplied Setting Values": "On submission of mail provider settings, you can validate the user-provided values using the `testConnection` method.\n\nIf validation fails, throw an exception to abort the save action and display an error message to the end user. The error message will be the message within the exception.\n\n```\n/**\n * Test connection.\n *\n * @param array $settings\n *\n * @return array\n */\npublic function testConnection($settings)\n{\n    $api_username = $settings['api_username'];\n    $api_password = $settings['api_password'];\n\n    // Attempt to connect to API service to verify input credentials\n    // and upon error, throw an exception.\n\n    throw new \\Exception('The system was unable to authenticate with the supplied API username and password.');\n}\n```"
      },
      "file": "mail-providers/provider-settings.md"
    },
    {
      "title": "Send Notification",
      "content": {},
      "file": "mail-providers/send-notification.md"
    },
    {
      "title": "Getting Started",
      "content": {
        "Sample Module": "The `SenderModuleInterface` interface for mail providers ships with WHMCS. The class that you create must be in the `WHMCS\\Module\\Mail` namespace.",
        "Choosing A Name": "Mail provider modules are in the `modules/mail` directory. Each module has its own subdirectory, which you should use to store the files relating to the module.\n\nMail provider modules are PHP files that contain a class that implements the `SenderModuleInterface` interface.\n\nTo create a new mail provider module, perform these steps:\n\n1. Choose a name for your module. Module names must be a single string that consists of only alphanumeric characters (no spaces or other characters). Names must begin with a letter and must be unique.\n2. Create a new directory using your desired module name.\n3. Create a new file within the directory, using your module name as the filename and the `.php` extension.\n4. Add the following code to the file, replacing `YourModuleName` with the name of your module:\n\n```\n<?php\n\nnamespace WHMCS\\Module\\Mail;\n\nuse WHMCS\\Authentication\\CurrentUser;\nuse WHMCS\\Exception\\Mail\\SendFailure;\nuse WHMCS\\Exception\\Module\\InvalidConfiguration;\nuse WHMCS\\Mail\\Message;\nuse WHMCS\\Module\\Contracts\\SenderModuleInterface;\nuse WHMCS\\Module\\MailSender\\DescriptionTrait;\n\n/**\n* YourModuleName\n*\n* @copyright Copyright (c) WHMCS Limited 2005-2020\n* @license http://www.example.com/\n*/\nclass YourModuleName implements SenderModuleInterface\n{\n    use DescriptionTrait;\n\n    /**\n     * Provider settings.\n     *\n     * @return array\n     */\n    public function settings()\n    {\n        return [\n            'username' => [\n                'FriendlyName' => 'Username',\n                'Type' => 'text',\n                'Description' => 'The Your Module Name username.',\n            ],\n            'password' => [\n                'FriendlyName' => 'Password',\n                'Type' => 'password',\n                'Description' => 'The Your Module Name password.',\n            ],\n        ];\n    }\n\n    /**\n     * Module name used internally\n     *\n     * @return string\n     */\n    public function getName()\n    {\n        return 'Yourmodulename';\n    }\n\n    /**\n     * Module name shown in the Admin Area\n     *\n     * @return string\n     */\n    public function getDisplayName()\n    {\n        return 'Your Module Name';\n    }\n\n    /**\n     * Test connection.\n     *\n     * @param array $settings\n     *\n     * @return array\n     */\n    public function testConnection(array $settings)\n    {\n        $currentAdmin = (new CurrentUser)->admin();\n\n        try {\n            $ch = curl_init();\n            curl_setopt($ch, CURLOPT_HTTPAUTH, CURLAUTH_BASIC);\n            curl_setopt($ch, CURLOPT_USERPWD, $settings['username'] . ':' . $settings['password']);\n            curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);\n\n            curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'POST');\n            curl_setopt($ch, CURLOPT_URL, 'https://example.com/api/messages');\n            curl_setopt($ch, CURLOPT_POSTFIELDS, [\n                'from' => 'test@example.com',\n                'to' => $currentAdmin->email,\n                'subject' => 'Your Module Name Test',\n                'html' => 'This email was sent to test the new mail configuration. If you received this message, '\n                    . 'it confirms that email is sending correctly. You do not need to take any further action.'\n            ]);\n\n            curl_exec($ch);\n            curl_close($ch);\n        } catch (Exception $e) {\n            throw new Exception(\"Unable to send a Test Message: \" . $e->getMessage());\n        }\n    }\n\n    /**\n     * This is responsible for delivering mail to the mail provider.\n     *\n     * @param array $settings\n     * @param Message $message\n     */\n    public function send(array $settings, Message $message)\n    {\n        try {\n\n            $postFields = [\n                'from' => $message->getFromName(),\n                'fromEmail' => $message->getFromEmail(),\n                'subject' => $message->getSubject(),\n            ];\n\n            // Retrieve recipients.\n            foreach ($message->getRecipients('to') as $to) {\n                $postFields['toEmail'][] = $to[0];\n                $postFields['toName'][] = $to[1];\n            }\n            foreach ($message->getRecipients('cc') as $cc) {\n                $postFields['ccEmail'][] = $cc[0];\n                $postFields['ccName'][] = $cc[1];\n            }\n            foreach ($message->getRecipients('bcc') as $bcc) {\n                $postFields['bccEmail'][] = $bcc[0];\n                $postFields['bccName'][] = $bcc[1];\n            }\n\n            $replyTo = $message->getReplyTo();\n            if ($replyTo) {\n                $postFields['replyToName'] = $replyTo['name'];\n                $postFields['replyToEmail'] = $replyTo['email'];\n            }\n\n            // Build body\n            $body = $message->getBody();\n            $plainText = $message->getPlainText();\n            if ($body) {\n                $postFields['html'] = $body;\n                if (empty($plainText)) {\n                    $plainText = ' ';\n                }\n                $postFields['text'] = $plainText;\n            } else {\n                $postFields['text'] = $plainText;\n            }\n\n            //Prepare attachments\n            $attachments = [];\n            foreach ($message->getAttachments() as $attachment) {\n                if (array_key_exists('data', $attachment)) {\n                    $filename = $attachment['filename'];\n                    $data = $attachment['data'];\n                } else {\n                    $filename = $attachment['filename'];\n                    $data = file_get_contents($attachment['filepath']);\n                }\n                $attachments[] = ['filename' => $filename, 'data' => $data];\n            }\n\n            $postFields['attachments'] = $attachments;\n\n            $ch = curl_init();\n            curl_setopt($ch, CURLOPT_HTTPAUTH, CURLAUTH_BASIC);\n            curl_setopt($ch, CURLOPT_USERPWD, $settings['username'] . ':' . $settings['password']);\n            curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);\n\n            curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'POST');\n            curl_setopt($ch, CURLOPT_URL, 'https://example.com/api/messages');\n            curl_setopt($ch, CURLOPT_POSTFIELDS, $postFields);\n\n            curl_exec($ch);\n            curl_close($ch);\n        } catch (Exception $e) {\n            throw new Exception(\"Unable to send a Test Message: \" . $e->getMessage());\n        }\n    }\n}\n```\n\nFor more information on the `SenderModuleInterface` and `Message` class, see [our additional documentation](https://classdocs.whmcs.com/8.1/WHMCS/Mail_ns.html)."
      },
      "file": "mail-providers/getting-started.md"
    }
  ]
}